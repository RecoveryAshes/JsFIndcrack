name: Build on macOS ARM

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos-arm:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        architecture: arm64
        
    - name: Verify ARM architecture
      run: |
        echo "Architecture: $(uname -m)"
        echo "Python architecture: $(python -c 'import platform; print(platform.machine())')"
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        # å®‰è£… Chrome ç”¨äº Selenium
        brew install --cask google-chrome
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Set up Node.js for webcrack
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install webcrack
      run: |
        npm install -g webcrack
        
    - name: Install Playwright browsers
      run: |
        playwright install chromium
        
    - name: Run basic tests
      run: |
        # æµ‹è¯•åŸºæœ¬å¯¼å…¥
        python -c "from src.core.js_crawler import JSCrawler; print('Import successful')"
        python -c "from src.utils.similarity_analyzer import SimilarityAnalyzer; print('Similarity analyzer import successful')"
        
    - name: Test crawler functionality
      run: |
        # è¿è¡Œä¸€ä¸ªç®€å•çš„æµ‹è¯•
        python main.py -u https://httpbin.org/html --mode static -d 1 -t 1 || echo "Test completed with expected behavior"
        
    - name: Create standalone executable
      run: |
        # åˆ›å»ºç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
        pyinstaller --onefile --name jsfindcrack-macos-arm64 \
          --add-data "src:src" \
          --hidden-import selenium \
          --hidden-import playwright \
          --hidden-import requests \
          --hidden-import beautifulsoup4 \
          --hidden-import lxml \
          --hidden-import numpy \
          --hidden-import scikit-learn \
          --hidden-import concurrent.futures \
          main.py
        
    - name: Test standalone executable
      run: |
        # æµ‹è¯•ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
        ./dist/jsfindcrack-macos-arm64 --help || echo "Executable test completed"
        
    - name: Create release package
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        mkdir -p release
        cp dist/jsfindcrack-macos-arm64 release/
        cp README.md release/
        cp LICENSE release/
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜
        cat > release/USAGE.md << 'EOF'
        # JSFindCrack - macOS ARM64 ç‹¬ç«‹ç‰ˆæœ¬
        
        ## ä½¿ç”¨æ–¹æ³•
        
        1. ç¡®ä¿ç³»ç»Ÿå·²å®‰è£… Chrome æµè§ˆå™¨
        2. è¿è¡Œå‘½ä»¤ï¼š
           ```bash
           ./jsfindcrack-macos-arm64 -u <ç›®æ ‡URL> [å…¶ä»–å‚æ•°]
           ```
        
        ## ç¤ºä¾‹
        ```bash
        # é™æ€çˆ¬å–
        ./jsfindcrack-macos-arm64 -u https://example.com --mode static
        
        # åŠ¨æ€çˆ¬å–
        ./jsfindcrack-macos-arm64 -u https://example.com --mode dynamic
        
        # æŸ¥çœ‹å¸®åŠ©
        ./jsfindcrack-macos-arm64 --help
        ```
        
        ## æ³¨æ„äº‹é¡¹
        - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ä¸‹è½½æµè§ˆå™¨é©±åŠ¨
        - ç¡®ä¿æœ‰ç½‘ç»œè¿æ¥ç”¨äºä¸‹è½½ä¾èµ–
        - è¾“å‡ºæ–‡ä»¶å°†ä¿å­˜åœ¨å½“å‰ç›®å½•çš„ output æ–‡ä»¶å¤¹ä¸­
        EOF
        
        # æ‰“åŒ…
        cd release
        tar -czf ../jsfindcrack-macos-arm64.tar.gz *
        cd ..
        
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: jsfindcrack-macos-arm64
        path: |
          jsfindcrack-macos-arm64.tar.gz
          dist/jsfindcrack-macos-arm64
        retention-days: 30
        
    - name: Archive logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          output/*/logs/
          output/*/detailed_log.txt
          *.log
        retention-days: 14
        
    - name: Generate release tag
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      id: tag
      run: |
        # ç”ŸæˆåŸºäºæ—¶é—´æˆ³çš„ç‰ˆæœ¬å·
        VERSION="v$(date +'%Y.%m.%d')-$(date +'%H%M')"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
        
    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.version }}
        name: "JSFindCrack macOS ARM64 ${{ steps.tag.outputs.version }}"
        body: |
          ## JSFindCrack macOS ARM64 ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
          
          ### ğŸš€ æ–°åŠŸèƒ½
          - æ”¯æŒ macOS ARM64 (Apple Silicon) æ¶æ„
          - ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ— éœ€å®‰è£… Python ç¯å¢ƒ
          - åŒ…å«å®Œæ•´çš„ä¾èµ–å’Œæµè§ˆå™¨æ”¯æŒ
          
          ### ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `jsfindcrack-macos-arm64.tar.gz` - å®Œæ•´å‘å¸ƒåŒ…ï¼ˆåŒ…å«å¯æ‰§è¡Œæ–‡ä»¶ã€æ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜ï¼‰
          - `jsfindcrack-macos-arm64` - ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `jsfindcrack-macos-arm64.tar.gz`
          2. è§£å‹ï¼š`tar -xzf jsfindcrack-macos-arm64.tar.gz`
          3. è¿è¡Œï¼š`./jsfindcrack-macos-arm64 -u <ç›®æ ‡URL> [å‚æ•°]`
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - macOS 11.0+ (Big Sur æˆ–æ›´æ–°ç‰ˆæœ¬)
          - Apple Silicon (M1/M2/M3) æˆ– Intel å¤„ç†å™¨
          - å·²å®‰è£… Google Chrome æµè§ˆå™¨
          
          ### ğŸ› ä¿®å¤å†…å®¹
          - ä¿®å¤äº†å¾ªç¯å¯¼å…¥é—®é¢˜
          - ä¼˜åŒ–äº†ä¾èµ–ç®¡ç†
          - æ”¹è¿›äº†æ„å»ºæµç¨‹
          
          ---
          
          **æ„å»ºä¿¡æ¯**
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - Python ç‰ˆæœ¬: 3.11
          - æ¶æ„: ARM64
        files: |
          jsfindcrack-macos-arm64.tar.gz
          dist/jsfindcrack-macos-arm64
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# 功能规格说明：Python到Go语言迁移

**功能分支**: `001-py-to-go-migration`
**创建日期**: 2025-11-15
**状态**: 草案
**用户描述**: "任务是从py转成go"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 命令行工具功能保持 (优先级: P1)

用户能够使用Go版本的JsFIndcrack工具执行与当前Python版本完全相同的JavaScript文件爬取和反混淆操作,包括单URL爬取、批量爬取、静态/动态模式切换等所有核心功能。

**优先级理由**: 这是最核心的功能等价性要求,确保迁移后工具对用户来说无感知、无破坏性变更。没有功能等价性,迁移就失去意义。

**独立测试**: 可以通过运行相同的命令行参数(如 `./jsfindcrack -u https://example.com -d 3`)并对比Python版本和Go版本的输出结果、文件内容、日志信息来完全验证此功能,交付的是一个可独立运行的完整工具。

**验收场景**:

1. **给定** Python版本工具的一个爬取任务(包含URL、深度、线程数等参数),**当** 使用相同参数运行Go版本工具,**那么** 输出文件数量、文件内容、目录结构应与Python版本一致
2. **给定** 包含多个URL的批量爬取文件,**当** 使用Go版本工具执行批量爬取,**那么** 每个URL的处理结果(成功/失败、文件数量)应与Python版本一致
3. **给定** 一个包含混淆JavaScript代码的网站,**当** 使用Go版本工具执行反混淆,**那么** 生成的decode文件内容应与Python版本一致
4. **给定** 需要使用断点续爬功能的场景,**当** 中断后恢复爬取,**那么** Go版本应能正确读取检查点并继续爬取

---

### 用户故事 2 - 性能提升 (优先级: P2)

用户在执行大规模JavaScript文件爬取任务时,能够感受到明显的性能提升,包括更快的并发处理速度、更低的内存占用和更好的系统资源利用率。

**优先级理由**: 性能提升是选择Go语言的主要动机之一。虽然功能等价性更重要,但性能优化是迁移带来的核心价值增量。

**独立测试**: 可以通过运行相同的大规模爬取任务(如批量爬取100个URL,每个URL深度为3),对比Python版本和Go版本的执行时间、内存峰值占用、CPU利用率等指标来验证。

**验收场景**:

1. **给定** 一个包含100个URL的批量爬取任务,**当** 分别用Python和Go版本执行,**那么** Go版本的总执行时间应比Python版本减少至少30%
2. **给定** 相同的并发爬取配置(如10个并发线程),**当** 执行相同任务,**那么** Go版本的内存峰值占用应比Python版本降低至少40%
3. **给定** 相似度分析任务(处理1000个JavaScript文件),**当** 执行并行相似度检测,**那么** Go版本应比Python版本快至少50%

---

### 用户故事 3 - 部署便利性 (优先级: P3)

用户能够获得单个可执行文件(无需安装Python运行时、依赖库等),支持跨平台部署(Linux、macOS、Windows),简化安装和分发流程。

**优先级理由**: 这是Go语言的附加优势,但不影响核心功能。对于已经熟悉Python环境的用户,这是锦上添花的改进。

**独立测试**: 可以通过在全新的操作系统环境(无Python、无npm)中直接运行Go编译的二进制文件,验证工具能否正常工作(除webcrack等外部依赖外)。

**验收场景**:

1. **给定** 一台全新的Linux服务器(无Python环境),**当** 下载Go版本的二进制文件并运行,**那么** 工具应能正常启动并执行基本爬取任务
2. **给定** Windows、macOS、Linux三个平台,**当** 使用交叉编译生成的可执行文件,**那么** 每个平台都应能正常运行所有功能
3. **给定** 需要分发工具给团队成员的场景,**当** 提供单个二进制文件,**那么** 用户无需执行复杂的安装步骤即可使用

---

### 边界情况

- 当处理超大文件(>50MB)时,Go版本是否能正确处理流式读写而不导致内存溢出?
- 当网络不稳定导致请求超时时,Go版本的重试机制是否与Python版本一致?
- 当遇到编码异常的JavaScript文件时,Go版本的错误处理是否能正确降级并记录日志?
- 当检查点文件损坏时,Go版本是否能正确提示错误并提供恢复建议?
- 当用户中断程序(Ctrl+C)时,Go版本是否能优雅退出并保存状态?

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须支持所有现有Python版本的命令行参数和选项(包括 `-u`, `-f`, `-d`, `-w`, `-t`, `--playwright-tabs`, `--mode`, `--resume`, `--similarity` 等)
- **FR-002**: 系统必须保持与Python版本相同的输出目录结构(`output/[domain]/encode/`, `decode/`, `checkpoints/`, `similarity_analysis_*/` 等)
- **FR-003**: 系统必须生成与Python版本格式兼容的报告文件(JSON格式的 `crawl_report.json`, `crawl_summary.json` 等)
- **FR-004**: 系统必须支持静态爬取(HTML解析)和动态爬取(Playwright浏览器自动化)两种模式
- **FR-005**: 系统必须支持JavaScript反混淆功能,调用外部webcrack工具
- **FR-006**: 系统必须支持智能相似度检测和去重功能
- **FR-007**: 系统必须支持断点续爬机制,能读取和写入检查点文件
- **FR-008**: 系统必须支持批量URL处理,支持错误容错(`--continue-on-error`)
- **FR-009**: 系统必须支持并发处理(多线程下载、并行相似度分析)
- **FR-010**: 系统必须生成结构化日志输出,包括主日志和错误日志
- **FR-011**: 系统必须保持与Python版本相同的错误提示和用户反馈信息(中文)
- **FR-012**: 系统必须支持Source Map文件的识别和下载
- **FR-013**: 系统必须在执行过程中显示进度信息(进度条、百分比、状态提示)

### 关键实体

- **爬取任务(Crawl Task)**: 表示一个完整的爬取操作,包含目标URL、爬取深度、模式选择、配置参数等信息
- **JavaScript文件(JS File)**: 表示从网站下载的JavaScript源文件,包含URL、内容、哈希值、文件大小、是否混淆等属性
- **Source Map文件(Map File)**: 表示JavaScript对应的Source Map文件,用于调试和源码映射
- **检查点(Checkpoint)**: 表示爬取任务的中间状态,包含已访问URL列表、已下载文件列表、当前进度等信息
- **相似度组(Similarity Group)**: 表示一组相似或重复的JavaScript文件,包含相似度分数、代表文件、重复文件列表等信息
- **爬取报告(Crawl Report)**: 表示爬取任务完成后的统计信息,包括成功/失败文件数、总大小、耗时等指标

## 成功标准 *(必填)*

### 可衡量结果

- **SC-001**: 用户使用Go版本工具执行与Python版本相同的爬取任务时,获得的文件数量和内容应100%一致
- **SC-002**: 在批量爬取100个URL的基准测试中,Go版本的总执行时间应比Python版本减少至少30%
- **SC-003**: 在相同负载下,Go版本的内存峰值占用应比Python版本降低至少40%
- **SC-004**: 所有现有Python版本的命令行参数和功能在Go版本中应100%可用且行为一致
- **SC-005**: Go版本工具应支持至少Linux、macOS、Windows三个主流平台的交叉编译和运行
- **SC-006**: 现有Python版本的所有配置文件(如config.py中的配置项)应能在Go版本中通过配置文件或环境变量方式保持兼容
- **SC-007**: 用户应能在5分钟内完成从Python版本到Go版本的迁移(替换可执行文件),无需修改现有工作流
- **SC-008**: Go版本应能正确处理至少1000个并发请求而不出现崩溃或数据丢失
- **SC-009**: 相似度分析功能在处理1000个文件时,Go版本应比Python版本快至少50%
- **SC-010**: Go版本应生成与Python版本格式完全兼容的检查点文件,确保可以相互恢复

## 假设与约束

### 假设

- webcrack工具(npm包)将继续作为外部依赖,通过命令行调用(不在迁移范围内)
- Playwright浏览器引擎将继续使用,Go版本通过Playwright的Go绑定或命令行接口调用
- 用户已安装必要的外部工具(webcrack、Playwright)
- 现有输出文件格式(JSON、文件目录结构)应保持不变以确保向后兼容

### 约束

- 迁移后的Go版本必须保持与Python版本相同的用户界面和命令行接口,不得引入破坏性变更
- 所有用户可见的文本(日志、错误信息、帮助文档)必须保持中文
- 配置文件格式可以从Python的`.py`迁移到Go的YAML/JSON/TOML等格式,但必须提供转换工具或说明
- 迁移过程应分阶段进行,优先保证核心爬取功能的等价性,然后逐步优化性能

## 范围界定

### 包含在内

- 所有核心爬取逻辑(静态、动态)的Go语言重写
- 反混淆功能的Go语言封装(调用webcrack)
- 相似度分析算法的Go语言实现
- 日志系统的Go语言重写
- 命令行参数解析和配置管理的Go语言实现
- 断点续爬机制的Go语言实现
- 批量处理和并发控制的Go语言实现
- 报告生成功能的Go语言实现

### 不包含在内

- webcrack工具本身的重写(继续作为外部依赖)
- Playwright浏览器引擎的重写(使用Go绑定)
- README.md的重写(保持英文,仅更新Go相关的安装和使用说明)
- 新功能的添加(仅迁移现有功能)
- 现有Python版本的维护(迁移后可选择性弃用或并行维护)
